from fastapi import FastAPI, Request
from settings import settings
from authlib.integrations.starlette_client import OAuth
from starlette.middleware.sessions import SessionMiddleware

oauth = OAuth()
oauth.register(
  name='kakao',
  client_id=settings.client_id,
  client_secret=settings.client_secret,
  # kakao developers의 url을 참고한다
  access_token_url="https://kauth.kakao.com/oauth/authorize",
  authorize_url="https://kauth.kakao.com/oauth/token",
  # kauth를 제외하고 kapi의 경로도 많이 이용하기 때문에 아래와 같이 등록한다
  api_base_url="https://kapi.kakao.com",
  # scope 안에는 동의 된거 및 받고 싶은 부분 넣는 거임
  # 우리가 따로 안 넣으면 카카오톡 측에서 자동으로 주는 정보만 가져옴
  client_kwargs={"scope": "profile_nickname profile_image"}
)
app = FastAPI(title=settings.title, root_path=settings.root_path)
app.add_middleware(
  SessionMiddleware,
  secret_key="your-secret-key-here"
)

@app.get("/")
def read_root():
  # oauth.kakao
  return {"service": "App2"}

@app.get("/login/kakao")
async def kakaoLogin(request: Request):
  redirect_uri = "http://localhost:8000/app1/oauth/callback/kakao"
  return oauth.kakao.authorize_redirect(request, redirect_uri)

@app.get("/oauth/callback/kakao")
async def kakaoCallback(code: str):
  return {"code": code}
